@{
    ViewData["Title"] = "Employee Attendance";
}

<div class="row mb-3">
    <div class="col-md-3">
        <select id="projectFilter" class="form-select">
            <option value="">-- All Projects --</option>
            @foreach (var project in ViewBag.Projects)
            {
                <option value="@project.Value">@project.Text</option>
            }
        </select>
    </div>

    <div class="col-md-3">
        <input type="text" id="searchBox" class="form-control" placeholder="Search Employee / Project" />
    </div>

    <div class="col-md-3">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAttendanceModal">
            Add Attendance
        </button>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-bordered table-striped" id="attendanceTable">
        <thead class="table-dark">
            <tr>
                <th>Employee</th>
                <th>Project</th>
                <th>Date</th>
                <th>Worked Hours</th>
                <th>Overtime</th>
                <th>Daily Salary</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="attendanceBody">
            @foreach (var item in ViewBag.AttendanceList)
            {
                <tr>
                    <td>@item.Employee?.Name</td>
                    <td>@item.Project?.ProjectName</td>
                    <td>@item.Date.ToString("dd-MMM-yyyy")</td>
                    <td>@item.WorkedHours</td>
                    <td>@item.OvertimeHours</td>
                    <td>@item.DailySalary</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-danger">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- ADD ATTENDANCE MODAL -->
<div class="modal fade" id="addAttendanceModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="addAttendanceForm">
                <div class="modal-header">
                    <h5>Add Attendance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-2">
                        <label>Employee</label>
                        <select id="EmployeeID" class="form-select" required>
                            <option value="">Select</option>
                            @foreach (var emp in ViewBag.Employees)
                            {
                                <option value="@emp.Value">@emp.Text</option>
                            }
                        </select>
                    </div>

                    <div class="mb-2">
                        <label>Project</label>
                        <select id="ProjectID" class="form-select" required>
                            <option value="">Select</option>
                            @foreach (var proj in ViewBag.Projects)
                            {
                                <option value="@proj.Value">@proj.Text</option>
                            }
                        </select>
                    </div>

                    <div class="mb-2">
                        <label>Date</label>
                        <input type="date" id="Date" class="form-control" required />
                    </div>

                    <div class="mb-2">
                        <label>Start Time</label>
                        <input type="time" id="StartTime" class="form-control" required />
                    </div>

                    <div class="mb-2">
                        <label>End Time</label>
                        <input type="time" id="EndTime" class="form-control" required />
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const body = document.getElementById("attendanceBody");
        const projectFilter = document.getElementById("projectFilter");
        const searchBox = document.getElementById("searchBox");

        function filterTable() {
            const projectText = projectFilter.options[projectFilter.selectedIndex].text.toLowerCase();
            const search = searchBox.value.toLowerCase();

            Array.from(body.rows).forEach(row => {
                const employee = row.cells[0].innerText.toLowerCase();
                const project = row.cells[1].innerText.toLowerCase();

                const projectMatch =
                    projectFilter.value === "" || project.includes(projectText);

                const searchMatch =
                    employee.includes(search) || project.includes(search);

                row.style.display = projectMatch && searchMatch ? "" : "none";
            });
        }

        projectFilter.addEventListener("change", filterTable);
        searchBox.addEventListener("keyup", filterTable);

        document.getElementById("addAttendanceForm").addEventListener("submit", function (e) {
            e.preventDefault();

            const data = {
                EmployeeID: document.getElementById("EmployeeID").value,
                ProjectID: document.getElementById("ProjectID").value,
                Date: document.getElementById("Date").value,
                StartTime: document.getElementById("StartTime").value,
                EndTime: document.getElementById("EndTime").value
            };

            fetch("@Url.Action("SaveAttendance", "Attendance")", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(r => {
                alert(r.message);
                location.reload();
            });
        });
    </script>
}
